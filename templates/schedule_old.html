{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">Schedule Management</h1>
        <div>
            <button class="btn btn-primary" onclick="generateNewSchedule()">
                <i class="fas fa-calendar-plus"></i>
                Generate Schedule
            </button>
            <button class="btn btn-success" onclick="exportSchedule()">
                <i class="fas fa-download"></i>
                Export
            </button>
        </div>
    </div>
    
    <div class="form-group" style="display: flex; gap: 1rem; align-items: center;">
        <label class="form-label">View Week:</label>
        <input type="week" class="form-control" id="week-selector" style="width: auto;">
        <button class="btn btn-primary" onclick="loadSchedule()">
            <i class="fas fa-search"></i>
            Load
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Weekly Schedule Grid</h2>
    </div>
    <div id="schedule-grid"></div>
</div>

<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Shift Coverage Overview</h2>
        </div>
        <div id="coverage-chart"></div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Employee Hours Summary</h2>
        </div>
        <div id="hours-chart"></div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Detailed Schedule</h2>
    </div>
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Employee</th>
                    <th>Shift</th>
                    <th>Role</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Hours</th>
                    <th>Overtime</th>
                </tr>
            </thead>
            <tbody id="schedule-table">
                <!-- Schedule data will be loaded here -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSchedule = [];
let currentWeekStart = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set default week to current week
    const now = new Date();
    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
    const weekString = `${startOfWeek.getFullYear()}-W${Math.ceil((startOfWeek.getDate() + startOfWeek.getDay()) / 7)}`;
    document.getElementById('week-selector').value = weekString;
    
    loadSchedule();
});

async function loadSchedule() {
    const weekInput = document.getElementById('week-selector').value;
    if (!weekInput) return;
    
    // Parse week input to get start date
    const [year, week] = weekInput.split('-W');
    const startDate = getWeekStartDate(parseInt(year), parseInt(week));
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 6);
    
    currentWeekStart = startDate;
    
    try {
        const response = await apiRequest(`/api/schedule?start_date=${startDate.toISOString().split('T')[0]}&end_date=${endDate.toISOString().split('T')[0]}`);
        currentSchedule = response;
        displaySchedule();
    } catch (error) {
        console.error('Failed to load schedule:', error);
    }
}

function getWeekStartDate(year, week) {
    const janFirst = new Date(year, 0, 1);
    const days = (week - 1) * 7;
    const startDate = new Date(janFirst);
    startDate.setDate(janFirst.getDate() + days - janFirst.getDay());
    return startDate;
}

function displaySchedule() {
    displayScheduleGrid();
    displayDetailedTable();
    displayCoverageChart();
    displayHoursChart();
}

function displayScheduleGrid() {
    const container = document.getElementById('schedule-grid');
    const days = [];
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(currentWeekStart.getDate() + i);
        days.push(date);
    }
    
    const gridHtml = days.map(date => {
        const dateStr = date.toISOString().split('T')[0];
        const dayShifts = currentSchedule.filter(shift => shift.date === dateStr);
        
        const dayShiftsHtml = dayShifts.filter(shift => shift.shift_type === 'Day').map(shift => `
            <div class="shift-item">
                ${shift.employee_name} - ${shift.role}
            </div>
        `).join('');
        
        const nightShiftsHtml = dayShifts.filter(shift => shift.shift_type === 'Night').map(shift => `
            <div class="shift-item shift-night">
                ${shift.employee_name} - ${shift.role}
            </div>
        `).join('');
        
        return `
            <div class="schedule-day">
                <div class="schedule-day-header">
                    ${date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: #667eea;">Day Shifts:</strong>
                    ${dayShiftsHtml || '<div style="color: #718096; font-style: italic;">No shifts</div>'}
                </div>
                <div>
                    <strong style="color: #2d3748;">Night Shifts:</strong>
                    ${nightShiftsHtml || '<div style="color: #718096; font-style: italic;">No shifts</div>'}
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `<div class="schedule-grid">${gridHtml}</div>`;
}

function displayDetailedTable() {
    const tbody = document.getElementById('schedule-table');
    
    if (currentSchedule.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No schedule data found for the selected week.</td></tr>';
        return;
    }
    
    const html = currentSchedule.map(shift => `
        <tr>
            <td>${new Date(shift.date).toLocaleDateString()}</td>
            <td>${shift.employee_name}</td>
            <td>${shift.shift_type}</td>
            <td>${shift.role}</td>
            <td>${shift.start_time}</td>
            <td>${shift.end_time}</td>
            <td>${shift.hours}</td>
            <td>
                ${shift.is_overtime ? 
                    '<span class="status-badge status-pending" style="background: #fed7d7; color: #c53030;">OT</span>' : 
                    '<span class="status-badge status-approved" style="background: #c6f6d5; color: #2f855a;">Regular</span>'
                }
            </td>
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

function displayCoverageChart() {
    const coverageData = {};
    
    currentSchedule.forEach(shift => {
        const date = shift.date;
        const shiftType = shift.shift_type;
        
        if (!coverageData[date]) {
            coverageData[date] = { Day: 0, Night: 0 };
        }
        
        coverageData[date][shiftType]++;
    });
    
    const dates = Object.keys(coverageData).sort();
    const dayCoverage = dates.map(date => coverageData[date].Day);
    const nightCoverage = dates.map(date => coverageData[date].Night);
    
    const data = [
        {
            x: dates.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
            y: dayCoverage,
            name: 'Day Coverage',
            type: 'bar',
            marker: { color: '#667eea' }
        },
        {
            x: dates.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
            y: nightCoverage,
            name: 'Night Coverage',
            type: 'bar',
            marker: { color: '#2d3748' }
        }
    ];
    
    const layout = {
        title: 'Daily Shift Coverage',
        xaxis: { title: 'Date' },
        yaxis: { title: 'Number of Staff' },
        barmode: 'group',
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Inter, sans-serif' }
    };
    
    Plotly.newPlot('coverage-chart', data, layout, {responsive: true});
}

function displayHoursChart() {
    const employeeHours = {};
    
    currentSchedule.forEach(shift => {
        if (!employeeHours[shift.employee_name]) {
            employeeHours[shift.employee_name] = 0;
        }
        employeeHours[shift.employee_name] += shift.hours;
    });
    
    const employees = Object.keys(employeeHours);
    const hours = employees.map(emp => employeeHours[emp]);
    
    const data = [{
        labels: employees,
        values: hours,
        type: 'pie',
        marker: {
            colors: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7', '#ffecd2', '#fcb69f', '#a8edea']
        }
    }];
    
    const layout = {
        title: 'Weekly Hours Distribution',
        paper_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Inter, sans-serif' }
    };
    
    Plotly.newPlot('hours-chart', data, layout, {responsive: true});
}

async function generateNewSchedule() {
    if (!confirm('This will generate a new schedule for the selected week. Continue?')) {
        return;
    }
    
    try {
        const response = await apiRequest('/api/schedule/generate', {
            method: 'POST',
            body: JSON.stringify({
                start_date: currentWeekStart.toISOString().split('T')[0],
                weeks: 1
            })
        });
        
        if (response.success) {
            showAlert('Schedule generated successfully!');
            loadSchedule(); // Refresh the display
        } else {
            showAlert('Failed to generate schedule: ' + response.error, 'danger');
        }
    } catch (error) {
        console.error('Schedule generation failed:', error);
    }
}

function exportSchedule() {
    if (currentSchedule.length === 0) {
        showAlert('No schedule data to export.', 'danger');
        return;
    }
    
    // Create CSV content
    const headers = ['Date', 'Employee', 'Shift Type', 'Role', 'Start Time', 'End Time', 'Hours', 'Overtime'];
    const csvContent = [
        headers.join(','),
        ...currentSchedule.map(shift => [
            shift.date,
            `"${shift.employee_name}"`,
            shift.shift_type,
            `"${shift.role}"`,
            shift.start_time,
            shift.end_time,
            shift.hours,
            shift.is_overtime ? 'Yes' : 'No'
        ].join(','))
    ].join('\n');
    
    // Download the file
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `schedule-${currentWeekStart.toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showAlert('Schedule exported successfully!');
}
</script>
{% endblock %}