{% extends "base.html" %}

{% block content %}
<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Request Time Off</h2>
        </div>
        <form id="timeoff-form">
            <div class="form-group">
                <label class="form-label">Employee *</label>
                <select class="form-control" id="employee-select" required>
                    <option value="">Select employee</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Start Date *</label>
                <input type="date" class="form-control" id="start-date" required>
            </div>
            <div class="form-group">
                <label class="form-label">End Date *</label>
                <input type="date" class="form-control" id="end-date" required>
            </div>
            <div class="form-group">
                <label class="form-label">Shift Type</label>
                <select class="form-control" id="shift-type">
                    <option value="BOTH" selected>Both Day & Night</option>
                    <option value="DAY">Day Shift Only</option>
                    <option value="NIGHT">Night Shift Only</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Reason</label>
                <textarea class="form-control" id="reason" rows="3" placeholder="Optional reason for time off request"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
                Submit Request
            </button>
        </form>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Time Off Calendar</h2>
        </div>
        <div id="timeoff-calendar"></div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Time Off Requests</h2>
        <div>
            <select class="form-control" id="status-filter" style="display: inline-block; width: auto;">
                <option value="">All Status</option>
                <option value="PENDING">Pending</option>
                <option value="APPROVED">Approved</option>
                <option value="DENIED">Denied</option>
            </select>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Employee</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Shift Type</th>
                    <th>Status</th>
                    <th>Reason</th>
                    <th>Requested</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="requests-table">
                <!-- Requests will be loaded here -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let employees = [];
let timeoffRequests = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadEmployees();
    loadTimeoffRequests();
    
    // Set default dates to next week
    const nextWeek = new Date();
    nextWeek.setDate(nextWeek.getDate() + 7);
    document.getElementById('start-date').value = nextWeek.toISOString().split('T')[0];
    
    const nextWeekPlusOne = new Date(nextWeek);
    nextWeekPlusOne.setDate(nextWeekPlusOne.getDate() + 1);
    document.getElementById('end-date').value = nextWeekPlusOne.toISOString().split('T')[0];
    
    // Add event listeners
    document.getElementById('status-filter').addEventListener('change', filterRequests);
});

async function loadEmployees() {
    try {
        const response = await apiRequest('/api/employees');
        employees = response;
        populateEmployeeSelect();
    } catch (error) {
        console.error('Failed to load employees:', error);
    }
}

function populateEmployeeSelect() {
    const select = document.getElementById('employee-select');
    select.innerHTML = '<option value="">Select employee</option>';
    
    employees.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.id;
        option.textContent = emp.name;
        select.appendChild(option);
    });
}

async function loadTimeoffRequests() {
    try {
        const response = await apiRequest('/api/timeoff');
        timeoffRequests = response;
        displayRequests();
        displayTimeoffCalendar();
    } catch (error) {
        console.error('Failed to load time off requests:', error);
    }
}

function displayRequests() {
    const tbody = document.getElementById('requests-table');
    
    if (timeoffRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No time off requests found.</td></tr>';
        return;
    }
    
    const html = timeoffRequests.map(request => `
        <tr>
            <td>${request.employee_name}</td>
            <td>${request.start_date}</td>
            <td>${request.end_date}</td>
            <td>${request.shift_type}</td>
            <td>
                <span class="status-badge status-${request.status.toLowerCase()}">
                    ${request.status}
                </span>
            </td>
            <td>${request.reason || 'No reason provided'}</td>
            <td>${new Date(request.created_at).toLocaleDateString()}</td>
            <td>
                ${request.status === 'PENDING' ? `
                    <button class="btn btn-success" onclick="approveRequest(${request.id})" style="padding: 0.5rem 1rem; margin-right: 0.5rem;">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-danger" onclick="denyRequest(${request.id})" style="padding: 0.5rem 1rem;">
                        <i class="fas fa-times"></i>
                    </button>
                ` : ''}
            </td>
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

function filterRequests() {
    const status = document.getElementById('status-filter').value;
    const rows = document.querySelectorAll('#requests-table tr');
    
    rows.forEach(row => {
        if (status === '') {
            row.style.display = '';
        } else {
            const statusCell = row.querySelector('.status-badge');
            if (statusCell && statusCell.textContent.trim() === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
}

async function approveRequest(requestId) {
    if (!confirm('Are you sure you want to approve this time off request?')) {
        return;
    }
    
    try {
        const response = await apiRequest(`/api/timeoff/${requestId}/approve`, {
            method: 'PUT'
        });
        
        if (response.success) {
            showAlert('Time off request approved successfully!');
            loadTimeoffRequests(); // Refresh the list
        } else {
            showAlert('Failed to approve request.', 'danger');
        }
    } catch (error) {
        console.error('Failed to approve request:', error);
    }
}

async function denyRequest(requestId) {
    if (!confirm('Are you sure you want to deny this time off request?')) {
        return;
    }
    
    try {
        const response = await apiRequest(`/api/timeoff/${requestId}/deny`, {
            method: 'PUT'
        });
        
        if (response.success) {
            showAlert('Time off request denied successfully!');
            loadTimeoffRequests(); // Refresh the list
        } else {
            showAlert('Failed to deny request.', 'danger');
        }
    } catch (error) {
        console.error('Failed to deny request:', error);
    }
}

function displayTimeoffCalendar() {
    const container = document.getElementById('timeoff-calendar');
    
    // Create a simple calendar view for the current month
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    const calendarHtml = `
        <div style="text-align: center; margin-bottom: 1rem;">
            <strong>${today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</strong>
        </div>
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border-radius: 8px; overflow: hidden;">
            ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `
                <div style="background: #f7fafc; padding: 0.5rem; text-align: center; font-weight: 600;">${day}</div>
            `).join('')}
            ${generateCalendarDays(firstDay, lastDay)}
        </div>
    `;
    
    container.innerHTML = calendarHtml;
}

function generateCalendarDays(firstDay, lastDay) {
    const days = [];
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay()); // Start from Sunday
    
    for (let i = 0; i < 42; i++) { // 6 weeks
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const isCurrentMonth = date.getMonth() === firstDay.getMonth();
        const hasTimeoff = timeoffRequests.some(request => {
            const requestStart = new Date(request.start_date);
            const requestEnd = new Date(request.end_date);
            return date >= requestStart && date <= requestEnd && request.status === 'APPROVED';
        });
        
        days.push(`
            <div style="background: white; padding: 0.5rem; min-height: 60px; ${!isCurrentMonth ? 'color: #cbd5e0;' : ''}">
                <div style="font-weight: 600;">${date.getDate()}</div>
                ${hasTimeoff ? '<div style="background: #f56565; color: white; font-size: 0.75rem; padding: 0.25rem; border-radius: 2px; margin-top: 0.25rem;">Time Off</div>' : ''}
            </div>
        `);
    }
    
    return days.join('');
}

// Handle form submission
document.getElementById('timeoff-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const employeeId = document.getElementById('employee-select').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!employeeId) {
        showAlert('Please select an employee.', 'danger');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        showAlert('Start date must be before or equal to end date.', 'danger');
        return;
    }
    
    const requestData = {
        employee_id: parseInt(employeeId),
        start_date: startDate,
        end_date: endDate,
        shift_type: document.getElementById('shift-type').value,
        reason: document.getElementById('reason').value
    };
    
    try {
        const response = await apiRequest('/api/timeoff', {
            method: 'POST',
            body: JSON.stringify(requestData)
        });
        
        if (response.success) {
            showAlert('Time off request submitted successfully!');
            document.getElementById('timeoff-form').reset();
            loadTimeoffRequests(); // Refresh the list
        } else {
            showAlert('Failed to submit request.', 'danger');
        }
    } catch (error) {
        console.error('Failed to submit request:', error);
    }
});
</script>
{% endblock %}